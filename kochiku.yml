test_command: 'square/script/ci'
retry_count: 1

# do this so the build does not install the version in .ruby-version
ruby:
  - 2.6

targets:
- type: build_bootstrap_image
  write_to_cache:
    - docker-cache-vitess-bootstrap/
- type: deployable_image
  requires:
    - build_bootstrap_image
  read_from_cache:
    - docker-cache-vitess-bootstrap/
  write_to_cache:
    - docker-cache/
- type: run-tests0
  retry_count: 3
  requires:
    - deployable_image
  read_from_cache:
    - docker-cache/
- type: run-tests1
  retry_count: 3
  requires:
    - deployable_image
  read_from_cache:
    - docker-cache/
- type: run-tests2
  retry_count: 3
  requires:
    - deployable_image
  read_from_cache:
    - docker-cache/
- type: run-tests4
  requires:
    - deployable_image
  read_from_cache:
    - docker-cache/
# these tests are currently failing. will uncomment once they are green again
#- type: run-tests4
#  retry_count: 3
#  requires:
#    - deployable_image
#  read_from_cache:
#    - docker-cache/
- type: cloud_vitess
  requires:
    - build_bootstrap_image
  read_from_cache:
    - docker-cache-vitess-bootstrap/
- type: jdbc
  requires:
    - deployable_image
    - run-tests0
    - run-tests1
    - run-tests2
    - run-tests4
#    - run-tests3
- type: binaries
  app_name: vitess-build
  partial_artifact: true
  requires:
    - deployable_image
    - run-tests0
    - run-tests1
    - run-tests2
    - run-tests4
#    - run-tests3
  read_from_cache:
    - docker-cache/

build_artifacts:
  vitess:
    distributions:
      # empty, this is only added to allow canary builds